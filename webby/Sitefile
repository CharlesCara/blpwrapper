result = `ps ux | awk '/prl_vm_app/ && !/awk/ {print $2}'`.chomp

EXAMPLES_DIRECTORY = "/private/tmp/#{result}/C/work/rbloomberg-examples/"

# Webby configuration
SITE.create_mode = 'directory'

# Webby (rake) tasks
task :default => :pdf

task :run_examples do
  # Export the examples directory to Windows VM or other R-accessible directory specified by EXAMPLES_DIRECTORY
  `cp content/examples/* #{EXAMPLES_DIRECTORY}`
  
  # Strip out any Idiopidae comment lines so they don't get executed.
  # They do no harm if they are executed, but they clutter up output.
  `ls #{EXAMPLES_DIRECTORY}/*.R`.chomp.split.each do |f|
    data = File.read(f)
    data = data.gsub(/^\#\#\#.*$\n/, "")
    
    File.open(f, "w") do |file|
      file.write data
    end
  end
  
  # TODO automatically run examples
  puts "files exported, now run them in R"
end

desc "create R PACKAGES and PACKAGES.gz"
task :r_packages do
  `R CMD BATCH tasks/package.R`
end

def r_project_version
  File.read("../rbloomberg/DESCRIPTION") =~ /^Version:\s*([0-9.-]+)\s*$/
  version = $1
  raise "no version detected" if version.nil?
  version
end

def r_source_files
  html = "<ul>"
  
  `ls content/R/bin/windows/contrib/2.9/*.zip`.chomp.split.each do |f|
    filename = f.gsub(/^content/, "")
    html << %{<li><a href="#{filename}">#{File.basename(filename)}</a></li>}
  end
  
  html + "</ul>"
end

def rbloomberg_manual_filename
  "rbloomberg-manual-#{r_project_version.gsub(".", "-")}.pdf"
end

desc "Rename generated file with RBloomberg version number."
task :copy do
  `mv output/rbloomberg/rbloomberg-manual.pdf output/rbloomberg/#{manual_filename}`
  `cp output/rbloomberg/#{manual_filename} ..`
end

require "gorgyrella"
